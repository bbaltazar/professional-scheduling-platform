# Alembic Migration Guide

## Overview

The project now uses Alembic for database schema migrations. This provides safe, versioned changes to the database schema with rollback capabilities.

## Quick Start

### Applying Migrations

```bash
# Apply all pending migrations
./scripts/migrate.sh upgrade

# Or use alembic directly
.venv/bin/alembic upgrade head
```

### Creating New Migrations

When you modify SQLAlchemy models in `database.py`:

```bash
# Create a new migration with autogenerate
./scripts/migrate.sh create "add user email index"

# Or use alembic directly
.venv/bin/alembic revision --autogenerate -m "add user email index"
```

### Checking Migration Status

```bash
# Show current migration
./scripts/migrate.sh current

# Show migration history
./scripts/migrate.sh history
```

### Rolling Back

```bash
# Rollback one migration
./scripts/migrate.sh downgrade

# Or use alembic directly
.venv/bin/alembic downgrade -1
```

## Workflow for Schema Changes

### 1. Modify Your Models

Edit `src/calendar_app/database.py` to make your changes:

```python
# Example: Add a new field
class Specialist(Base):
    __tablename__ = "specialists"
    
    # ... existing fields ...
    
    bio = Column(Text, nullable=True)  # NEW FIELD
```

### 2. Generate Migration

```bash
./scripts/migrate.sh create "add specialist bio field"
```

This will:
- Auto-detect your model changes
- Create a new migration file in `alembic/versions/`
- Include both `upgrade()` and `downgrade()` functions

### 3. Review the Migration

Check the generated file in `alembic/versions/` to ensure it's correct:

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.add_column('specialists', sa.Column('bio', sa.Text(), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.drop_column('specialists', 'bio')
    # ### end Alembic commands ###
```

### 4. Apply the Migration

```bash
./scripts/migrate.sh upgrade
```

## Important Notes

### Database Creation

- **Old approach (removed):** `Base.metadata.create_all(bind=engine)`
- **New approach:** Use Alembic migrations

For a fresh database:
```bash
.venv/bin/alembic upgrade head
```

### Initial Setup (Already Done)

The initial migration (`77fb5ce9d2e1`) has been created and stamped. This captures your current schema with all indexes.

### What Alembic Tracks

Alembic uses a special `alembic_version` table in your database to track which migrations have been applied. Never modify this table manually.

### Testing Migrations

Always test migrations in development first:

1. Backup your database: `cp calendar_app.db calendar_app.db.backup`
2. Apply migration: `./scripts/migrate.sh upgrade`
3. Test your application
4. If issues occur: `./scripts/migrate.sh downgrade`
5. Restore backup if needed: `cp calendar_app.db.backup calendar_app.db`

## Common Scenarios

### Adding an Index

```bash
# 1. Add index to model
class Booking(Base):
    client_phone = Column(String, nullable=True, index=True)  # Added index=True

# 2. Generate migration
./scripts/migrate.sh create "add index to booking client_phone"

# 3. Apply
./scripts/migrate.sh upgrade
```

### Adding a New Table

```bash
# 1. Add new SQLAlchemy model in database.py
class Invoice(Base):
    __tablename__ = "invoices"
    id = Column(Integer, primary_key=True)
    # ... other fields ...

# 2. Generate migration
./scripts/migrate.sh create "add invoice table"

# 3. Apply
./scripts/migrate.sh upgrade
```

### Renaming a Column

Alembic cannot auto-detect renames. You must edit the migration manually:

```bash
# 1. Generate migration
./scripts/migrate.sh create "rename booking status to state"

# 2. Edit the generated file and replace the add/drop with:
def upgrade():
    op.alter_column('bookings', 'status', new_column_name='state')

def downgrade():
    op.alter_column('bookings', 'state', new_column_name='status')

# 3. Apply
./scripts/migrate.sh upgrade
```

### Data Migrations

You can include data changes in migrations:

```python
from alembic import op
import sqlalchemy as sa

def upgrade():
    # Schema change
    op.add_column('specialists', sa.Column('verified', sa.Boolean(), nullable=True))
    
    # Data migration
    connection = op.get_bind()
    connection.execute(
        sa.text("UPDATE specialists SET verified = 1 WHERE email IS NOT NULL")
    )
    
    # Make column non-nullable after setting defaults
    op.alter_column('specialists', 'verified', nullable=False)
```

## Production Deployment

### Before Deploying

1. Review all pending migrations
2. Test migrations on a copy of production data
3. Create a database backup

### Deployment Process

```bash
# 1. Backup production database
cp calendar_app.db calendar_app.db.backup.$(date +%Y%m%d_%H%M%S)

# 2. Apply migrations
./scripts/migrate.sh upgrade

# 3. Start application
./start.sh
```

### Rollback Plan

If issues occur after deployment:

```bash
# Stop application
# Rollback migration
./scripts/migrate.sh downgrade

# Or restore from backup
cp calendar_app.db.backup.TIMESTAMP calendar_app.db

# Restart application
```

## Configuration

### Files

- `alembic.ini` - Alembic configuration
- `alembic/env.py` - Migration environment setup
- `alembic/versions/` - Migration files
- `scripts/migrate.sh` - Helper script

### Database URL

Currently configured in `alembic.ini`:
```ini
sqlalchemy.url = sqlite:///./calendar_app.db
```

For production with environment variables:
```python
# Edit alembic/env.py
from calendar_app.config import settings

config.set_main_option('sqlalchemy.url', settings.database_url)
```

## Troubleshooting

### "Target database is not up to date"

```bash
# Check current state
./scripts/migrate.sh current

# Apply pending migrations
./scripts/migrate.sh upgrade
```

### "Can't locate revision identified by 'head'"

Your `alembic_version` table may be corrupted:

```bash
# Check what migration is recorded
sqlite3 calendar_app.db "SELECT * FROM alembic_version;"

# Stamp to correct version
.venv/bin/alembic stamp head
```

### Migration File Not Generated Correctly

Sometimes autogenerate misses changes:

1. Review the generated migration
2. Edit manually if needed
3. Common issues:
   - Column renames (appear as drop + add)
   - Index changes on existing columns
   - Enum type changes

### SQLite Limitations

SQLite has limited ALTER TABLE support:
- Cannot drop columns (requires table recreation)
- Cannot modify column types easily
- Some operations require data migration

Alembic handles these with table recreation when needed.

## References

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [Migration Tutorial](https://alembic.sqlalchemy.org/en/latest/tutorial.html)

## Current State

- **Initial Migration:** `77fb5ce9d2e1_initial_migration.py`
- **Status:** Applied and stamped
- **Includes:** All current tables and indexes
- **Database:** `calendar_app.db` (tracked in Alembic)
